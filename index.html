<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cricket Score Overlay</title>
<style>
  body {margin:0; background:transparent; font-family: Arial, sans-serif; color:white;}
  .scorebar {
    position: fixed; top:10px; left:50%; transform:translateX(-50%);
    width:90%; background: linear-gradient(to right, rgba(0,0,0,0.7), rgba(30,30,30,0.5));
    border-radius:20px; padding:12px 15px; box-sizing:border-box;
    box-shadow:0 4px 12px rgba(0,0,0,0.6), 0 0 15px rgba(255,255,255,0.2);
    backdrop-filter: blur(4px);
  }
  .row {display:grid; grid-template-columns:1.5fr 3fr 1.5fr; align-items:center; margin:5px 0;}
  .left {text-align:left;} .center {text-align:center;} .right {text-align:right;}
  .player {font-size:26px; font-weight:bold; text-shadow:1px 1px 2px black;}
  .bowler {font-size:24px; font-weight:bold; text-shadow:1px 1px 2px black;}
  .scoreline {font-size:30px; font-weight:bold; text-shadow:2px 2px 6px black; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .team1 {color:#ffd700; font-weight:bold;} .team2 {color:#1e90ff; font-weight:bold;} .vs {color:#fff; font-weight:bold;}
  .crr {font-size:18px; font-style:italic; color:white; text-shadow:1px 1px 2px black;}
  .ball {display:inline-block; margin:0 2px; padding:3px 6px; border-radius:50%; font-weight:bold; font-size:14px; color:white; text-align:center;}
  .dot {background: gray;} .run {background: green;} .four {background: blue;} .six {background: gold; color:black;} .wicket {background: red;} .wide {background: orange;}
  @keyframes flashAnim {0%{background:rgba(255,255,255,0.8);} 50%{background:rgba(255,255,255,0);} 100%{background:rgba(255,255,255,0);}}
  .flash {animation: flashAnim 0.8s ease forwards;}
  @keyframes bounce {0%{transform:translateY(0);} 30%{transform:translateY(-8px);} 50%{transform:translateY(0);} 70%{transform:translateY(-4px);} 100%{transform:translateY(0);}}
  .bounce {animation: bounce 0.5s ease forwards;}
</style>
</head>
<body>

<div class="scorebar">
  <div class="row">
    <div class="left player" id="player1">Loading...</div>
    <div class="center scoreline" id="scoreline">Loading...</div>
    <div class="right bowler" id="bowler">Loading...</div>
  </div>
  <div class="row">
    <div class="left player" id="player2">Loading...</div>
    <div class="center crr" id="crr">Loading...</div>
    <div class="right" id="lastover">Loading...</div>
  </div>
</div>

<script>
// Your sheet JSON endpoint
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBBphs5H4uRDzOf_wVI4ExfDz3hDAFYn3GWi9uorlEfN3MJLlfgzFfsKq94ccgGg/gviz/tq?tqx=out:json&gid=658195036";

let lastBalls = [];
let lastBowler = "";
let lastCRR = "";

function formatBallClass(ball) {
  const b = ball.trim().toLowerCase();
  if (b === "w") return "ball wicket";
  if (b === "0") return "ball dot";
  if (b === "wd") return "ball wide";
  if (b === "4") return "ball four";
  if (b === "6") return "ball six";
  if (!isNaN(b)) return "ball run";
  return "ball";
}

function flashNewBalls(el, newBalls) {
  const htmlBalls = newBalls.map((ball, i) => {
    const isNew = lastBalls[i] !== ball;
    const ballClass = formatBallClass(ball);
    return `<span class="${ballClass}${isNew ? ' bounce' : ''}">${ball}</span>`;
  }).join(" ");
  el.innerHTML = "This Over: " + htmlBalls;
  lastBalls = [...newBalls];
}

function flashIfChanged(el, newValue, lastValue) {
  if(newValue !== lastValue) {
    el.classList.add("flash");
    setTimeout(() => el.classList.remove("flash"), 800);
  }
}

function adjustFontSize(el, maxWidth) {
  let fontSize = 30;
  el.style.fontSize = fontSize + "px";
  while (el.scrollWidth > maxWidth && fontSize > 14) {
    fontSize -= 1;
    el.style.fontSize = fontSize + "px";
  }
}

function colorScoreline(text){
  const parts = text.split(/vs/i);
  if(parts.length === 2){
    return `<span class="team1">${parts[0].trim()}</span> <span class="vs">vs</span> <span class="team2">${parts[1].trim()}</span>`;
  }
  return text;
}

async function fetchScore() {
  try {
    const res = await fetch(sheetURL + "&t=" + Date.now(), { cache: "no-store" });
    const text = await res.text();

    // Match the JSON inside google.visualization.Query.setResponse(...)
    const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
    if (!match) throw new Error("Unexpected response format from Google Sheets");

    const json = JSON.parse(match[1]);

    const row = json.table.rows[0].c.map(cell => cell ? cell.v : "");

    document.getElementById("player1").innerText = row[0] || "";
    document.getElementById("player2").innerText = row[1] || "";
    document.getElementById("scoreline").innerHTML = colorScoreline(row[2] || "");

    const bowlerEl = document.getElementById("bowler");
    bowlerEl.innerText = row[4] || "";
    flashIfChanged(bowlerEl, row[4] || "", lastBowler);
    lastBowler = row[4] || "";

    const crrEl = document.getElementById("crr");
    crrEl.innerText = row[3] || "";
    flashIfChanged(crrEl, row[3] || "", lastCRR);
    lastCRR = row[3] || "";

    if (row[5]) {
      const ballsText = row[5].replace(/^This Over:\s*/i, "");
      const balls = ballsText.split(" ");
      flashNewBalls(document.getElementById("lastover"), balls);
    }

    adjustFontSize(
      document.getElementById("scoreline"),
      document.getElementById("scoreline").parentElement.offsetWidth
    );

  } catch (e) {
    console.error("Error fetching score:", e);
    document.getElementById("scoreline").innerText = "âš  No update from sheet";
  }
}

fetchScore();
setInterval(fetchScore, 1000); // refresh every 1 second
</script>

</body>
</html>
