<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Cricket Overlay</title>
<style>
body {
  margin: 0;
  background: transparent;
  font-family: Arial, sans-serif;
  color: white;
}
.scorebar {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 95%;
  background: rgba(0, 0, 0, 0.6);
  padding: 10px 15px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
}
.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 3px 0;
}
.center {
  flex: 1;
  text-align: center;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  font-weight: bold;
  font-size: 22px;
  text-shadow: 1px 1px 2px black;
}
.right {
  text-align: right;
  font-weight: bold;
  font-size: 18px;
  text-shadow: 1px 1px 2px black;
}
.ball {
  display: inline-block;
  margin: 0 2px;
  padding: 3px 6px;
  border-radius: 50%;
  font-weight: bold;
  font-size: 14px;
  color: white;
  text-align: center;
}
.dot { background: gray; }
.run { background: green; }
.four { background: blue; }
.six { background: gold; color:black; }
.wicket { background: red; }
.wide { background: orange; }
@keyframes bounce { 0%{ transform:translateY(0); } 30%{ transform:translateY(-6px); } 50%{ transform:translateY(0); } 70%{ transform:translateY(-3px); } 100%{ transform:translateY(0); } }
.bounce { animation: bounce 0.4s ease forwards; }
.hidden { display: none; }
.team1 { color: #ffd700; font-weight: bold; }
.team2 { color: #1e90ff; font-weight: bold; }
.vs { color: #ffffff; font-weight: bold; }
</style>
</head>
<body>

<div class="scorebar">
  <div class="row">
    <div class="center" id="ticker"></div>
    <div class="right" id="bowlerCRR"></div>
  </div>
  <div class="row">
    <div class="center" id="lastover"></div>
  </div>
</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1FUl5P--46Q7uzgUYEcmkVVdwzsRqTpad/gviz/tq?tqx=out:json&gid=658195036";
let lastBalls = [];
let lastValues = {};

function formatBallClass(ball) {
  const b = ball.trim().toLowerCase();
  if (b === "w") return "ball wicket";
  if (b === "0") return "ball dot";
  if (b === "wd") return "ball wide";
  if (b === "4") return "ball four";
  if (b === "6") return "ball six";
  if (!isNaN(b)) return "ball run";
  return "ball";
}

function flashNewBalls(el, newBalls) {
  if (!newBalls.length) { el.classList.add("hidden"); return; }
  el.classList.remove("hidden");
  const htmlBalls = newBalls.map((ball, i) => {
    const isNew = lastBalls[i] !== ball;
    const ballClass = formatBallClass(ball);
    return `<span class="${ballClass}${isNew ? ' bounce' : ''}">${ball}</span>`;
  }).join(" ");
  el.innerHTML = htmlBalls;
  lastBalls = [...newBalls];
}

function formatTicker(player1, player2, ticker) {
  const vsParts = ticker.split(/vs/i);
  let formattedTicker = ticker;
  if (vsParts.length === 2) {
    formattedTicker = `<span class="team1">${vsParts[0].trim()}</span> <span class="vs">vs</span> <span class="team2">${vsParts[1].trim()}</span>`;
  }
  return `${player1} | ${player2} | ${formattedTicker}`;
}

async function fetchScore() {
  try {
    const res = await fetch(sheetURL + "&t=" + Date.now(), { cache: "no-store" });
    const text = await res.text();
    const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
    if (!match) throw new Error("Unexpected response format");
    const json = JSON.parse(match[1]);

    const data = {};
    json.table.rows.forEach(r => {
      const key = r.c[0]?.v?.trim();
      const value = r.c[1]?.v?.trim() || "";
      if (key) data[key] = value;
    });

    // Ticker
    const newTicker = formatTicker(data["Player 1"] || "", data["Player 2"] || "", data["Ticker"] || "");
    const tickerEl = document.getElementById("ticker");
    if (lastValues["ticker"] !== newTicker) {
      tickerEl.innerHTML = newTicker;
      lastValues["ticker"] = newTicker;
    }

    // Bowler + CRR
    const bowlerCRREl = document.getElementById("bowlerCRR");
    const bowlerCRRText = `${data["Bowler"] || ""} | CRR: ${data["CRR"] || ""}`;
    if (lastValues["bowlerCRR"] !== bowlerCRRText) {
      bowlerCRREl.innerText = bowlerCRRText;
      lastValues["bowlerCRR"] = bowlerCRRText;
    }

    // Last Over
    const ballsText = data["This Over"] || "";
    const balls = ballsText.split(" ").filter(b => b);
    flashNewBalls(document.getElementById("lastover"), balls);

  } catch (e) {
    console.error("Error fetching score:", e);
  }
}

fetchScore();
setInterval(fetchScore, 1000);
</script>

</body>
</html>
