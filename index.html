<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cricket Score Overlay</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; background:transparent; font-family:Arial,sans-serif; color:white; }
.scorebar {
  position: fixed; top:10px; left:50%; transform:translateX(-50%);
  width:98%; max-width:1600px;
  background: linear-gradient(to right, rgba(0,0,0,0.7), rgba(30,30,30,0.5));
  border-radius:25px; padding:12px 20px; box-sizing:border-box;
  box-shadow:0 4px 12px rgba(0,0,0,0.6), 0 0 15px rgba(255,255,255,0.2);
  backdrop-filter: blur(4px);
}
.row { display:grid; grid-template-columns:1.5fr 3fr 1.5fr; align-items:center; margin:5px 0; }
.left { text-align:left; } .center { text-align:center; } .right { text-align:right; }

.player { font-size:18px; font-weight:bold; text-shadow:1px 1px 2px black; }
.bowler { font-size:16px; font-weight:bold; text-shadow:1px 1px 2px black; }
.scoreline { font-size:20px; font-weight:bold; text-shadow:2px 2px 6px black; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.crr { font-size:14px; font-style:italic; color:white; text-shadow:1px 1px 2px black; }
#lastover { font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.ball { display:inline-block; margin:0 2px; padding:3px 6px; border-radius:50%; font-weight:bold; text-align:center; color:white; }
.dot { background: gray; } .run { background: green; } .four { background: blue; } .six { background: gold; color:black; } .wicket { background: red; } .wide { background: orange; }

@keyframes flashAnim { 0%{ background:rgba(255,255,255,0.8); } 50%{ background:rgba(255,255,255,0); } 100%{ background:rgba(255,255,255,0); } }
.flash { animation: flashAnim 0.8s ease forwards; }

@keyframes bounce { 0%{ transform:translateY(0); } 30%{ transform:translateY(-6px); } 50%{ transform:translateY(0); } 70%{ transform:translateY(-3px); } 100%{ transform:translateY(0); } }
.bounce { animation: bounce 0.5s ease forwards; }

.hidden { display:none; }
</style>
</head>
<body>

<div class="scorebar">
  <div class="row">
    <div class="left player" id="player1"></div>
    <div class="center scoreline" id="scoreline"></div>
    <div class="right bowler" id="bowler"></div>
  </div>
  <div class="row">
    <div class="left player" id="player2"></div>
    <div class="center crr" id="crr"></div>
    <div class="right" id="lastover"></div>
  </div>
</div>

<script>
// Your Google Sheets JSON endpoint (Visualization API)
const sheetURL = "https://docs.google.com/spreadsheets/d/1FUl5P--46Q7uzgUYEcmkVVdwzsRqTpad/gviz/tq?tqx=out:json&gid=658195036";

let lastBalls = [];
let lastValues = {};

const fieldMap = {
  "Player 1": "player1",
  "Player 2": "player2",
  "Ticker": "scoreline",
  "CRR": "crr",
  "Bowler": "bowler",
  "This Over": "lastover"
};

function formatBallClass(ball) {
  const b = ball.trim().toLowerCase();
  if (b === "w") return "ball wicket";
  if (b === "0") return "ball dot";
  if (b === "wd") return "ball wide";
  if (b === "4") return "ball four";
  if (b === "6") return "ball six";
  if (!isNaN(b)) return "ball run";
  return "ball";
}

function flashNewBalls(el, newBalls) {
  if (!newBalls.length) { el.classList.add("hidden"); return; }
  el.classList.remove("hidden");
  const htmlBalls = newBalls.map((ball, i) => {
    const isNew = lastBalls[i] !== ball;
    const ballClass = formatBallClass(ball);
    return `<span class="${ballClass}${isNew ? ' bounce' : ''}">${ball}</span>`;
  }).join(" ");
  el.innerHTML = "This Over: " + htmlBalls;
  lastBalls = [...newBalls];

  // Shrink if too wide
  let fontSize = 14;
  const maxWidth = el.parentElement.offsetWidth;
  const minFont = 10;
  el.style.fontSize = fontSize + "px";
  while (el.scrollWidth > maxWidth && fontSize > minFont) {
    fontSize -= 1;
    el.style.fontSize = fontSize + "px";
  }
}

function flashIfChanged(el, key, newValue) {
  if (lastValues[key] !== newValue) {
    el.classList.add("flash");
    setTimeout(() => el.classList.remove("flash"), 800);
  }
  lastValues[key] = newValue;
}

function adjustFontSize(el, maxWidth) {
  let fontSize = parseInt(window.getComputedStyle(el).fontSize);
  const minFont = 12;
  while (el.scrollWidth > maxWidth && fontSize > minFont) {
    fontSize -= 1;
    el.style.fontSize = fontSize + "px";
  }
}

function colorScoreline(text){
  const parts = text.split(/vs/i);
  if (parts.length === 2) {
    return `<span class="team1">${parts[0].trim()}</span> <span class="vs">vs</span> <span class="team2">${parts[1].trim()}</span>`;
  }
  return text;
}

async function fetchScore() {
  try {
    const res = await fetch(sheetURL + "&t=" + Date.now(), { cache:"no-store" });
    const text = await res.text();

    const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
    if (!match) throw new Error("Unexpected response format from Google Sheets");

    const json = JSON.parse(match[1]);
    const rows = json.table.rows;

    const data = {};
    rows.forEach(r => {
      if(r.c && r.c[0] && r.c[0].v){
        const [key, value] = r.c[0].v.split(":").map(s=>s.trim());
        if(key && value) data[key] = value;
      }
    });

    Object.keys(fieldMap).forEach(sheetKey => {
      const elId = fieldMap[sheetKey];
      const el = document.getElementById(elId);
      if(el && data[sheetKey]){
        if(sheetKey === "Ticker"){
          el.innerHTML = colorScoreline(data[sheetKey]);
          adjustFontSize(el, el.parentElement.offsetWidth);
        } else if(sheetKey === "This Over"){
          const balls = data[sheetKey].split(" ").filter(b=>b);
          flashNewBalls(el, balls);
        } else if(sheetKey === "CRR"){
          el.innerText = "CRR: " + data[sheetKey];
        } else {
          el.innerText = data[sheetKey];
        }
        flashIfChanged(el, sheetKey, data[sheetKey]);
      }
    });

  } catch(e){
    console.error("Error fetching score:", e);
  }
}

fetchScore();
setInterval(fetchScore, 1000);
</script>

</body>
</html>
