<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cricket Score Overlay</title>
<style>
  body { margin:0; background:transparent; font-family: Arial, sans-serif; color:white; }
  .scorebar {
    position: fixed; top:10px; left:50%; transform:translateX(-50%);
    width:95%; background: linear-gradient(to right, rgba(0,0,0,0.7), rgba(30,30,30,0.5));
    border-radius:20px; padding:12px 15px; box-sizing:border-box;
    box-shadow:0 4px 12px rgba(0,0,0,0.6), 0 0 15px rgba(255,255,255,0.2);
    backdrop-filter: blur(4px);
  }
  .row { display:grid; grid-template-columns:1.5fr 3fr 1.5fr; align-items:center; margin:5px 0; }
  .left { text-align:left; } .center { text-align:center; } .right { text-align:right; }
  .player { font-size:26px; font-weight:bold; text-shadow:1px 1px 2px black; }
  .bowler { font-size:24px; font-weight:bold; text-shadow:1px 1px 2px black; }
  .scoreline { font-size:30px; font-weight:bold; text-shadow:2px 2px 6px black; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .team1 { color:#ffd700; font-weight:bold; } .team2 { color:#1e90ff; font-weight:bold; } .vs { color:#ffffff; font-weight:bold; }
  .crr { font-size:18px; font-style:italic; color:white; text-shadow:1px 1px 2px black; }
  .ball { display:inline-block; margin:0 2px; padding:3px 6px; border-radius:50%; font-weight:bold; font-size:14px; color:white; text-align:center; }
  .dot { background: gray; } .run { background: green; } .four { background: blue; } .six { background: gold; color:black; } .wicket { background: red; } .wide { background: orange; }
  @keyframes flashAnim { 0%{ background:rgba(255,255,255,0.8); } 50%{ background:rgba(255,255,255,0); } 100%{ background:rgba(255,255,255,0); } }
  .flash { animation: flashAnim 0.8s ease forwards; }
  @keyframes bounce { 0%{ transform:translateY(0); } 30%{ transform:translateY(-8px); } 50%{ transform:translateY(0); } 70%{ transform:translateY(-4px); } 100%{ transform:translateY(0); } }
  .bounce { animation: bounce 0.5s ease forwards; }
  .hidden { display:none; }
</style>
</head>
<body>

<div class="scorebar">
  <div class="row">
    <div class="left player" id="player1"></div>
    <div class="center scoreline" id="scoreline"></div>
    <div class="right bowler" id="bowler"></div>
  </div>
  <div class="row">
    <div class="left player" id="player2"></div>
    <div class="center crr" id="crr"></div>
    <div class="right" id="lastover"></div>
  </div>
</div>

<script>
const sheetCSV = "https://docs.google.com/spreadsheets/d/e/YOUR_PUBLISHED_CSV_LINK/pub?output=csv";

let lastBalls = [];
let lastValues = {};

function formatBallClass(ball) {
  const b = ball.trim().toLowerCase();
  if (b === "w") return "ball wicket";
  if (b === "0") return "ball dot";
  if (b === "wd") return "ball wide";
  if (b === "4") return "ball four";
  if (b === "6") return "ball six";
  if (!isNaN(b)) return "ball run";
  return "ball";
}

function flashNewBalls(el, newBalls) {
  if (!newBalls.length) { el.classList.add("hidden"); return; }
  el.classList.remove("hidden");
  const htmlBalls = newBalls.map((ball,i)=>{
    const isNew = lastBalls[i] !== ball;
    const ballClass = formatBallClass(ball);
    return `<span class="${ballClass}${isNew?' bounce':''}">${ball}</span>`;
  }).join(" ");
  el.innerHTML = "This Over: " + htmlBalls;
  lastBalls = [...newBalls];
}

function adjustFontSize(el,maxWidth){
  if(!el.innerText.trim() && !el.innerHTML.trim()){ el.classList.add("hidden"); return; }
  el.classList.remove("hidden");
  let fontSize = 30;
  el.style.fontSize = fontSize + "px";
  while(el.scrollWidth>maxWidth && fontSize>14){ fontSize-=1; el.style.fontSize=fontSize+"px"; }
}

function colorScoreline(text){
  const parts = text.split(/vs/i);
  if(parts.length===2){
    return `<span class="team1">${parts[0].trim()}</span> <span class="vs">vs</span> <span class="team2">${parts[1].trim()}</span>`;
  }
  return text;
}

function flashIfChanged(el,key,newVal){
  if(lastValues[key] !== newVal){
    el.classList.add("flash");
    setTimeout(()=>el.classList.remove("flash"),800);
    lastValues[key]=newVal;
  }
}

async function fetchScoreCSV() {
  try{
    // Correct cache-busting URL
    const url = sheetCSV.includes("?") ? sheetCSV + "&t=" + Date.now() : sheetCSV + "?t=" + Date.now();
    const res = await fetch(url,{cache:"no-store"});
    const text = await res.text();

    const rows = text.trim().split("\n").map(r=>{
      const parts = r.split(/,(.+)/).map(c => c.replace(/^"|"$/g,'').trim());
      return parts;
    });

    const data = {};
    rows.forEach(r=>{
      if(r[0]) data[r[0]] = r[1] || "";
    });

    const player1 = document.getElementById("player1");
    player1.innerText = data["Player 1"] || "";
    player1.classList.toggle("hidden", !data["Player 1"]);
    flashIfChanged(player1,"Player 1",data["Player 1"]);

    const player2 = document.getElementById("player2");
    player2.innerText = data["Player 2"] || "";
    player2.classList.toggle("hidden", !data["Player 2"]);
    flashIfChanged(player2,"Player 2",data["Player 2"]);

    const scoreline = document.getElementById("scoreline");
    scoreline.innerHTML = data["Ticker"] ? colorScoreline(data["Ticker"]) : "";
    scoreline.classList.toggle("hidden", !data["Ticker"]);
    adjustFontSize(scoreline, scoreline.parentElement.offsetWidth);
    flashIfChanged(scoreline,"Ticker",data["Ticker"]);

    const crr = document.getElementById("crr");
    crr.innerText = data["CRR"] ? "CRR: " + data["CRR"] : "";
    crr.classList.toggle("hidden", !data["CRR"]);
    flashIfChanged(crr,"CRR",data["CRR"]);

    const bowler = document.getElementById("bowler");
    bowler.innerText = data["Bowler"] || "";
    bowler.classList.toggle("hidden", !data["Bowler"]);
    flashIfChanged(bowler,"Bowler",data["Bowler"]);

    if(data["This Over"]){
      const balls = data["This Over"].split(" ").filter(b=>b);
      flashNewBalls(document.getElementById("lastover"),balls);
    } else {
      document.getElementById("lastover").classList.add("hidden");
    }

  } catch(e){
    console.error("Error fetching CSV:", e);
    document.getElementById("scoreline").innerText="âš  No update from sheet";
  }
}

fetchScoreCSV();
setInterval(fetchScoreCSV,1000);
</script>

</body>
</html>
